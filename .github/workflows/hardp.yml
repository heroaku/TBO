name: Ultra Safe Sync

on: workflow_dispatch

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 创建全新的工作区
      - name: Prepare fresh workspace
        run: |
          # 直接克隆仓库，不使用actions/checkout
          git clone https://github.com/heroaku/TBO.git workspace
          cd workspace
          echo "WORKSPACE=$(pwd)" >> $GITHUB_ENV
          
      - name: Setup and sync
        env:
          WORKSPACE: ${{ env.WORKSPACE }}
        run: |
          cd "$WORKSPACE"
          
          # 配置
          git config user.name "Sync Bot"
          git config user.email "sync@bot.com"
          
          # 同步AX
          echo "同步 AX..."
          tmp=$(mktemp -d)
          git clone --depth 1 https://github.com/alantang1977/X.git "$tmp"
          
          mkdir -p AX
          rm -rf AX/*
          cp -r "$tmp"/* AX/ 2>/dev/null || true
          rm -rf "$tmp"
          
          # 安全提交
          git add .
          git commit -m "Sync"
          
      - name: Push with token
        env:
          WORKSPACE: ${{ env.WORKSPACE }}
        run: |
          cd "$WORKSPACE"
          
          # 使用token推送（如果需要创建PAT）
          # git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/heroaku/TBO.git
          
          # 或者使用普通推送
          git push
