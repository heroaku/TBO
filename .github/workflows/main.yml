name: Sync DBY and N3RD Repositories

on: 
  workflow_dispatch:        # 只支持手动运行 

concurrency: 
  group: sync_repositories_lock 
  cancel-in-progress: true   # 防止多个任务同时运行 

jobs: 
  sync_repositories: 
    runs-on: ubuntu-latest 

    steps: 
      # ✅ 步骤1：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}  # 使用个人访问令牌

      - name: Set up Git config 
        run: | 
          git config user.name "github-actions[bot]" 
          git config user.email "github-actions[bot]@users.noreply.github.com" 

      # ✅ 步骤2：设置认证（用于克隆私有仓库）
      - name: Setup authentication
        run: |
          # 配置 Git 使用当前 token 进行认证
          echo "配置 Git 认证..."
          
          # 方法1：为特定仓库配置 token
          git config --global url."https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com".insteadOf "https://github.com"
          
          # 方法2：或使用环境变量
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
          echo "PAT_TOKEN=${{ secrets.PAT_TOKEN }}" >> $GITHUB_ENV

      # ✅ 步骤3：动态分支处理
      - name: Setup default branch 
        run: | 
          set -e
          echo "配置分支信息..."
          
          # 使用当前工作流的 token 重新配置 remote
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          
          # 获取远程信息
          git fetch origin
          
          # 检测默认分支
          DEFAULT_BRANCH="main"
          if git show-ref --verify --quiet refs/remotes/origin/main 2>/dev/null; then
            DEFAULT_BRANCH="main"
          elif git show-ref --verify --quiet refs/remotes/origin/master 2>/dev/null; then
            DEFAULT_BRANCH="master"
          else
            echo "没有检测到远程分支，将创建 main 分支"
            # 创建初始文件
            echo "# TBO Repository" > README.md
            git add README.md
            git commit -m "Initial commit" || true
            git branch -M main
          fi
          
          echo "使用分支: $DEFAULT_BRANCH"
          git checkout -B $DEFAULT_BRANCH
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV

      # ✅ 步骤4：同步仓库（使用认证）
      - name: Fetch repositories 
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: | 
          echo "==== 开始同步仓库 ====" 
          
          # 创建目标文件夹
          mkdir -p DBY N3RD
          
          # 同步 DBY 仓库（使用认证）
          echo "→ 同步 huangxinyueus/dby 到 DBY 文件夹"
          
          # 使用 token 进行克隆
          if [ -n "$GH_TOKEN" ]; then
            echo "使用 token 认证克隆仓库..."
            # 带认证的克隆命令
            git clone --depth 1 --branch main "https://x-access-token:$GH_TOKEN@github.com/huangxinyueus/dby.git" temp-DBY || {
              echo "使用 token 克隆失败，尝试公开访问..."
              git clone --depth 1 --branch main "https://github.com/huangxinyueus/dby.git" temp-DBY || true
            }
          else
            echo "使用公开访问克隆仓库..."
            git clone --depth 1 --branch main "https://github.com/huangxinyueus/dby.git" temp-DBY || true
          fi
          
          # 复制文件
          if [ -d "temp-DBY" ]; then
            cp -r temp-DBY/* DBY/ 2>/dev/null || echo "注意：DBY 文件夹可能为空"
            rm -rf temp-DBY
          else
            echo "警告：DBY 仓库克隆失败"
          fi
          
          # 同步 N3RD 仓库
          echo "→ 同步 n3rddd/N3RD 到 N3RD 文件夹"
          
          if [ -n "$GH_TOKEN" ]; then
            git clone --depth 1 --branch main "https://x-access-token:$GH_TOKEN@github.com/n3rddd/N3RD.git" temp-N3RD || {
              echo "使用 token 克隆失败，尝试公开访问..."
              git clone --depth 1 --branch main "https://github.com/n3rddd/N3RD.git" temp-N3RD || true
            }
          else
            git clone --depth 1 --branch main "https://github.com/n3rddd/N3RD.git" temp-N3RD || true
          fi
          
          # 复制文件
          if [ -d "temp-N3RD" ]; then
            cp -r temp-N3RD/* N3RD/ 2>/dev/null || echo "注意：N3RD 文件夹可能为空"
            rm -rf temp-N3RD
          else
            echo "警告：N3RD 仓库克隆失败"
          fi

          echo "==== 同步完成 ====" 
          
          # 更新文件时间戳
          if [ -d "DBY" ]; then
            find DBY -type f -exec touch {} + 2>/dev/null || true
          fi
          if [ -d "N3RD" ]; then
            find N3RD -type f -exec touch {} + 2>/dev/null || true
          fi

      # ✅ 步骤5：提交更改
      - name: Commit and push changes
        run: |
          set -e
          
          # 配置推送认证
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          
          # 检查是否有更改
          git status
          
          # 添加所有更改
          git add -A
          
          # 提交更改
          if git diff --cached --quiet; then
            echo "没有更改需要提交"
          else
            echo "提交更改..."
            DEFAULT_BRANCH=${DEFAULT_BRANCH:-main}
            git commit -m "Sync repositories - DBY & N3RD - $(date '+%Y-%m-%d %H:%M:%S')"
            
            # 推送到远程
            echo "推送到分支: $DEFAULT_BRANCH"
            git push origin $DEFAULT_BRANCH || {
              echo "推送失败，尝试强制推送..."
              git push origin $DEFAULT_BRANCH --force
            }
          fi

      # ✅ 步骤6：同步到 master 分支
      - name: Sync to master branch
        run: |
          set -e
          DEFAULT_BRANCH=${DEFAULT_BRANCH:-main}
          
          echo "同步到 master 分支..."
          
          # 创建或切换到 master 分支
          if git show-ref --verify --quiet refs/heads/master 2>/dev/null || git show-ref --verify --quiet refs/remotes/origin/master 2>/dev/null; then
            git checkout master
          else
            git checkout -b master
          fi
          
          # 合并默认分支的内容
          git merge --allow-unrelated-histories -X theirs $DEFAULT_BRANCH --no-commit || true
          git add -A
          git commit -m "Merge from $DEFAULT_BRANCH" || true
          
          # 推送到 master
          git push origin master --force-with-lease || git push origin master --force
          echo "✅ master 分支同步完成"
