name: Sync DBY and N3RD Repositories (For Old Repo)

on: 
  workflow_dispatch:        # åªæ”¯æŒæ‰‹åŠ¨è¿è¡Œ 

jobs: 
  sync_repositories: 
    runs-on: ubuntu-latest 

    steps: 
      # âœ… æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆä½¿ç”¨æµ…å…‹éš†é¿å…å†å²é—®é¢˜ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤

      - name: Set up Git config 
        run: | 
          git config user.name "github-actions[bot]" 
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # âœ… æ­¥éª¤2ï¼šæ™ºèƒ½æ£€æµ‹é»˜è®¤åˆ†æ”¯ï¼ˆä¸“é—¨å¤„ç†è€ä»“åº“ï¼‰
      - name: Detect and setup default branch
        run: |
          set -e
          echo "=== æ£€æµ‹è€ä»“åº“çš„åˆ†æ”¯ç»“æ„ ==="
          
          # è·å–æ‰€æœ‰è¿œç¨‹åˆ†æ”¯
          echo "è·å–è¿œç¨‹åˆ†æ”¯åˆ—è¡¨..."
          git fetch origin
          
          # åˆ—å‡ºæ‰€æœ‰è¿œç¨‹åˆ†æ”¯
          echo "è¿œç¨‹åˆ†æ”¯åˆ—è¡¨:"
          git branch -r
          
          # å°è¯•å¤šç§æ–¹å¼è·å–é»˜è®¤åˆ†æ”¯
          echo "å°è¯•æ£€æµ‹é»˜è®¤åˆ†æ”¯..."
          
          # æ–¹æ³•1ï¼šä» remote show è·å– HEAD branch
          if DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}'); then
            echo "æ–¹æ³•1æ£€æµ‹åˆ°é»˜è®¤åˆ†æ”¯: $DEFAULT_BANCH"
          fi
          
          # æ–¹æ³•2ï¼šå¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ï¼Œå°è¯•å¸¸è§çš„åˆ†æ”¯å
          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "å°è¯•å¸¸è§åˆ†æ”¯å..."
            for branch in master main; do
              if git show-ref --verify --quiet refs/remotes/origin/$branch 2>/dev/null; then
                DEFAULT_BRANCH=$branch
                echo "æ‰¾åˆ°åˆ†æ”¯: $DEFAULT_BRANCH"
                break
              fi
            done
          fi
          
          # æ–¹æ³•3ï¼šå¦‚æœè¿˜æ²¡æœ‰ï¼Œè·å–ç¬¬ä¸€ä¸ªè¿œç¨‹åˆ†æ”¯
          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿œç¨‹åˆ†æ”¯..."
            DEFAULT_BRANCH=$(git branch -r | grep -v '\->' | head -n 1 | sed 's|origin/||' | xargs)
            echo "ä½¿ç”¨åˆ†æ”¯: $DEFAULT_BRANCH"
          fi
          
          # æ–¹æ³•4ï¼šå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½¿ç”¨ master
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="master"
            echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯å: $DEFAULT_BRANCH"
          fi
          
          echo "æœ€ç»ˆç¡®å®šçš„åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯
          echo "åˆ‡æ¢åˆ°åˆ†æ”¯: $DEFAULT_BRANCH"
          if git show-ref --verify --quiet refs/remotes/origin/$DEFAULT_BRANCH 2>/dev/null; then
            # åˆ†æ”¯å­˜åœ¨ï¼Œæ£€å‡º
            git checkout $DEFAULT_BRANCH 2>/dev/null || git checkout -b $DEFAULT_BRANCH origin/$DEFAULT_BRANCH
          else
            # åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯
            echo "åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯: $DEFAULT_BRANCH"
            git checkout -b $DEFAULT_BRANCH
            # åˆ›å»ºåˆå§‹æäº¤
            echo "# è‡ªåŠ¨åŒæ­¥ä»“åº“ - åˆå§‹æäº¤" > README_SYNC.md
            git add README_SYNC.md
            git commit -m "åˆå§‹æäº¤: è‡ªåŠ¨åŒæ­¥å·¥ä½œæµ" || true
          fi
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV
          echo "åˆ†æ”¯è®¾ç½®å®Œæˆ"

      # âœ… æ­¥éª¤3ï¼šåŒæ­¥å¤–éƒ¨ä»“åº“
      - name: Sync external repositories
        run: |
          echo "=== å¼€å§‹åŒæ­¥å¤–éƒ¨ä»“åº“ ==="
          
          # åˆ›å»ºç›®å½•
          mkdir -p DBY N3RD
          
          echo "1. åŒæ­¥ DBY ä»“åº“..."
          # å°è¯•å…‹éš† DBY ä»“åº“
          if git clone --depth 1 https://github.com/huangxinyueus/dby.git temp_dby 2>/dev/null; then
            # æ£€æŸ¥æ˜¯å¦æœ‰ main åˆ†æ”¯ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤åˆ†æ”¯
            cd temp_dby
            if git branch -a | grep -q "main"; then
              echo "DBY ä½¿ç”¨ main åˆ†æ”¯"
            else
              # åˆ‡æ¢åˆ°å®é™…çš„åˆ†æ”¯
              ACTUAL_BRANCH=$(git branch -a | grep -E "^\*" | cut -d' ' -f2)
              echo "DBY ä½¿ç”¨åˆ†æ”¯: $ACTUAL_BRANCH"
            fi
            cd ..
            cp -r temp_dby/* DBY/ 2>/dev/null || true
            rm -rf temp_dby
          else
            echo "DBY ä»“åº“åŒæ­¥å¤±è´¥"
          fi
          
          echo "2. åŒæ­¥ N3RD ä»“åº“..."
          # å°è¯•å…‹éš† N3RD ä»“åº“
          if git clone --depth 1 https://github.com/n3rddd/N3RD.git temp_n3rd 2>/dev/null; then
            cp -r temp_n3rd/* N3RD/ 2>/dev/null || true
            rm -rf temp_n3rd
          else
            echo "N3RD ä»“åº“åŒæ­¥å¤±è´¥"
          fi
          
          echo "åŒæ­¥å®Œæˆ"
          echo "DBY ç›®å½•å†…å®¹:"
          ls -la DBY/ 2>/dev/null || echo "DBY ç›®å½•ä¸ºç©º"
          echo "N3RD ç›®å½•å†…å®¹:"
          ls -la N3RD/ 2>/dev/null || echo "N3RD ç›®å½•ä¸ºç©º"

      # âœ… æ­¥éª¤4ï¼šæäº¤æ›´æ”¹
      - name: Commit changes
        run: |
          set -e
          echo "=== å‡†å¤‡æäº¤æ›´æ”¹ ==="
          
          # æ˜¾ç¤ºçŠ¶æ€
          echo "Git çŠ¶æ€:"
          git status --short
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          else
            echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
            DEFAULT_BRANCH=${DEFAULT_BRANCH:-$(git branch --show-current)}
            git commit -m "ğŸ”„ åŒæ­¥æ›´æ–° [$DEFAULT_BRANCH]
            
            æ›´æ–°å†…å®¹:
            - åŒæ­¥ DBY ä»“åº“åˆ° DBY/ ç›®å½•
            - åŒæ­¥ N3RD ä»“åº“åˆ° N3RD/ ç›®å½•
            - æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            
            è€ä»“åº“é€‚é…ç‰ˆæœ¬"
            
            echo "æäº¤å®Œæˆ"
          fi

      # âœ… æ­¥éª¤5ï¼šæ¨é€æ›´æ”¹
      - name: Push changes
        run: |
          set -e
          echo "=== å¼€å§‹æ¨é€ ==="
          
          CURRENT_BRANCH=$(git branch --show-current)
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          
          # å°è¯•æ¨é€
          echo "å°è¯•æ¨é€åˆ° origin/$CURRENT_BRANCH..."
          
          if git push origin $CURRENT_BRANCH 2>&1; then
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "æ¨é€å¤±è´¥ï¼Œå°è¯•è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯..."
            # è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯å¹¶æ¨é€
            git push --set-upstream origin $CURRENT_BRANCH 2>&1 || {
              echo "è®¾ç½®ä¸Šæ¸¸å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€..."
              git push origin $CURRENT_BRANCH --force
            }
          fi

      # âœ… æ­¥éª¤6ï¼šå¤„ç† master åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
      - name: Handle master branch
        if: env.DEFAULT_BRANCH != 'master'
        run: |
          echo "=== å¤„ç† master åˆ†æ”¯ ==="
          DEFAULT_BRANCH=${DEFAULT_BRANCH:-$(git branch --show-current)}
          
          # æ£€æŸ¥ master æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/master 2>/dev/null || \
             git show-ref --verify --quiet refs/remotes/origin/master 2>/dev/null; then
            echo "master åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹..."
            git checkout master 2>/dev/null || git checkout -b master
            git merge --allow-unrelated-histories -X theirs $DEFAULT_BRANCH --no-commit || true
            git add -A
            git commit -m "åˆå¹¶ $DEFAULT_BRANCH åˆ° master" || true
            git push origin master --force-with-lease 2>&1 || git push origin master --force 2>&1 || echo "master æ¨é€å¤±è´¥"
            
            # åˆ‡å›åŸåˆ†æ”¯
            git checkout $DEFAULT_BRANCH
          else
            echo "master åˆ†æ”¯ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
