name: Batch Sync and Verify

on: workflow_dispatch

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出当前仓库
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      # 2. 配置Git
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      # 3. 显示同步前状态
      - name: Show before status
        run: |
          echo "=== 同步前状态 ==="
          echo "时间: $(date)"
          echo ""
          
          if [ -d "DBY" ]; then
            echo "📁 DBY 文件夹:"
            echo "现有文件数: $(find DBY -type f 2>/dev/null | wc -l)"
          else
            echo "❌ DBY 文件夹不存在（将创建）"
          fi
          
          echo ""
          
          if [ -d "N3RD" ]; then
            echo "📁 N3RD 文件夹:"
            echo "现有文件数: $(find N3RD -type f 2>/dev/null | wc -l)"
          else
            echo "❌ N3RD 文件夹不存在（将创建）"
          fi
          
          echo ""
          echo "开始同步..."
          
      # 4. 批量同步所有仓库
      - name: Batch sync all repositories
        run: |
          echo "=== 开始批量同步 ==="
          echo ""
          
          # 定义要同步的仓库列表
          declare -A REPOSITORIES=(
            ["DBY"]="https://github.com/huangxinyueus/dby.git"
            ["N3RD"]="https://github.com/n3rddd/N3RD.git"
            # 您可以在这里添加更多仓库
            # ["FOLDER_NAME"]="GIT_URL"
          )
          
          # 同步计数器
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          # 遍历并同步每个仓库
          for FOLDER_NAME in "${!REPOSITORIES[@]}"; do
            echo ""
            echo "🔄 同步: $FOLDER_NAME"
            echo "源仓库: ${REPOSITORIES[$FOLDER_NAME]}"
            
            # 确保目标文件夹存在
            mkdir -p "$FOLDER_NAME"
            
            # 创建临时目录
            TEMP_DIR=$(mktemp -d)
            
            # 尝试克隆
            if git clone --depth 1 --quiet "${REPOSITORIES[$FOLDER_NAME]}" "$TEMP_DIR" 2>/dev/null; then
              # 清空目标文件夹
              find "$FOLDER_NAME" -mindepth 1 -delete 2>/dev/null || true
              
              # 复制文件（包括隐藏文件）
              shopt -s dotglob
              cp -r "$TEMP_DIR"/* "$FOLDER_NAME"/ 2>/dev/null || true
              shopt -u dotglob
              
              # 统计文件数
              FILE_COUNT=$(find "$FOLDER_NAME" -type f 2>/dev/null | wc -l)
              
              echo "✅ 同步成功"
              echo "   文件数量: $FILE_COUNT"
              
              ((SUCCESS_COUNT++))
            else
              echo "❌ 同步失败"
              echo "   原因: 仓库可能不存在、网络问题或权限不足"
              
              # 创建错误标记文件
              echo "# 同步失败 - $FOLDER_NAME" > "$FOLDER_NAME/ERROR.md"
              echo "源仓库: ${REPOSITORIES[$FOLDER_NAME]}" >> "$FOLDER_NAME/ERROR.md"
              echo "时间: $(date)" >> "$FOLDER_NAME/ERROR.md"
              
              ((FAIL_COUNT++))
            fi
            
            # 清理临时目录
            rm -rf "$TEMP_DIR"
          done
          
          echo ""
          echo "=== 批量同步完成 ==="
          echo "成功: $SUCCESS_COUNT 个仓库"
          echo "失败: $FAIL_COUNT 个仓库"
          
          # 保存统计信息
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "FAIL_COUNT=$FAIL_COUNT" >> $GITHUB_ENV
          
      # 5. 显示同步后状态
      - name: Show after status
        run: |
          echo ""
          echo "=== 同步后状态 ==="
          echo "时间: $(date)"
          echo ""
          
          # 显示每个文件夹的详细信息
          for folder in DBY N3RD; do
            if [ -d "$folder" ]; then
              echo "📁 $folder 文件夹:"
              echo "   文件总数: $(find "$folder" -type f 2>/dev/null | wc -l)"
              echo "   目录总数: $(find "$folder" -type d 2>/dev/null | wc -l)"
              echo "   最新文件:"
              find "$folder" -type f -exec ls -la {} \; 2>/dev/null | head -3 | while read line; do
                echo "     $line"
              done
            else
              echo "❌ $folder 文件夹不存在"
            fi
            echo ""
          done
          
      # 6. 生成同步报告
      - name: Generate sync report
        run: |
          echo "=== 生成同步报告 ==="
          
          # 创建详细的同步报告
          cat > SYNC_REPORT.md << 'EOF'
          # 批量同步报告
          
          ## 基本信息
          - **同步时间**: $(date)
          - **仓库地址**: https://github.com/${{ github.repository }}
          - **工作流**: [查看详情](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ## 同步统计
          | 文件夹 | 源仓库 | 文件数量 | 状态 |
          |--------|--------|----------|------|
          EOF
          
          # 为每个同步的文件夹添加行
          for folder in DBY N3RD; do
            if [ -d "$folder" ]; then
              FILE_COUNT=$(find "$folder" -type f 2>/dev/null | wc -l)
              
              # 根据是否有错误文件判断状态
              if [ -f "$folder/ERROR.md" ]; then
                STATUS="❌ 失败"
                REPO_URL="同步失败"
              else
                STATUS="✅ 成功"
                if [ "$folder" = "DBY" ]; then
                  REPO_URL="https://github.com/huangxinyueus/dby"
                elif [ "$folder" = "N3RD" ]; then
                  REPO_URL="https://github.com/n3rddd/N3RD"
                fi
              fi
              
              echo "| $folder | $REPO_URL | $FILE_COUNT | $STATUS |" >> SYNC_REPORT.md
            fi
          done
          
          cat >> SYNC_REPORT.md << 'EOF'
          
          ## 摘要
          - **总计同步**: $((SUCCESS_COUNT + FAIL_COUNT)) 个仓库
          - **成功**: $SUCCESS_COUNT 个
          - **失败**: $FAIL_COUNT 个
          
          ## 后续操作
          1. 如需重新同步，再次运行此工作流
          2. 查看具体文件请访问仓库页面
          3. 添加更多仓库请编辑工作流文件
          
          ---
          *报告由 GitHub Actions 自动生成*
          EOF
          
          echo "✅ 同步报告已生成"
          cat SYNC_REPORT.md
          
      # 7. 提交更改
      - name: Commit changes
        run: |
          echo "=== 提交更改 ==="
          
          # 添加所有更改的文件
          git add -A
          
          # 检查是否有实际更改
          if ! git diff --cached --quiet; then
            echo "检测到更改，正在提交..."
            
            # 获取提交统计
            DBY_COUNT=$(find DBY -type f 2>/dev/null | wc -l || echo 0)
            N3RD_COUNT=$(find N3RD -type f 2>/dev/null | wc -l || echo 0)
            
            git commit -m "🔄 批量同步完成 - $(date '+%Y-%m-%d %H:%M')
            
            📊 同步统计:
            • DBY: $DBY_COUNT 个文件
            • N3RD: $N3RD_COUNT 个文件
            • 状态: $SUCCESS_COUNT 成功 / $FAIL_COUNT 失败
            
            📋 详细报告请查看 SYNC_REPORT.md
            "
            
            echo "✅ 更改已提交"
          else
            echo "⚠️ 没有检测到更改（可能内容相同）"
          fi
          
      # 8. 推送到远程
      - name: Push to remote
        run: |
          echo "=== 推送到远程仓库 ==="
          
          # 尝试推送
          if git push origin HEAD; then
            echo "✅ 已成功推送到远程仓库"
            echo ""
            echo "🎉 批量同步完成！"
            echo "👉 查看更新: https://github.com/${{ github.repository }}"
          else
            echo "❌ 推送失败，尝试强制推送..."
            
            if git push origin HEAD --force; then
              echo "✅ 强制推送成功"
            else
              echo "❌ 推送完全失败，请检查权限设置"
              echo "建议: 检查仓库 Settings → Actions → Workflow permissions"
            fi
          fi
          
      # 9. 最终总结
      - name: Final summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "          批量同步工作流总结            "
          echo "========================================"
          echo ""
          echo "📅 执行时间: $(date)"
          echo "🏠 目标仓库: ${{ github.repository }}"
          echo "📊 同步结果: $SUCCESS_COUNT 成功 / $FAIL_COUNT 失败"
          echo ""
          echo "同步的文件夹:"
          echo "  • DBY/  ← https://github.com/huangxinyueus/dby"
          echo "  • N3RD/ ← https://github.com/n3rddd/N3RD"
          echo ""
          echo "📁 查看结果: https://github.com/${{ github.repository }}"
          echo "📋 详细报告: SYNC_REPORT.md"
          echo ""
          echo "🔄 如需更新: 重新运行此工作流"
          echo "========================================"
