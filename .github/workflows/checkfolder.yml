name: Fix Repository Permissions

on: workflow_dispatch

permissions:
  contents: write

jobs:
  fix-permissions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Fix all permissions
        run: |
          echo "=== ä¿®å¤ä»“åº“æƒé™ ==="
          
          # æ˜¾ç¤ºå½“å‰æƒé™
          echo "ä¿®å¤å‰æƒé™:"
          ls -la
          
          # ä¿®å¤ç›®å½•æƒé™
          echo "ä¿®å¤ç›®å½•æƒé™..."
          find . -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # ä¿®å¤æ–‡ä»¶æƒé™ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶é™¤å¤–ï¼‰
          echo "ä¿®å¤æ–‡ä»¶æƒé™..."
          find . -type f -exec chmod 644 {} \; 2>/dev/null || true
          
          # ä¿®å¤è„šæœ¬æ–‡ä»¶æƒé™
          echo "ä¿®å¤è„šæœ¬æ–‡ä»¶æƒé™..."
          find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
          find . -name "*.py" -exec chmod +x {} \; 2>/dev/null || true
          
          # ä¿®å¤ .git ç›®å½•æƒé™
          echo "ä¿®å¤ .git æƒé™..."
          chmod -R 755 .git 2>/dev/null || true
          
          # ä¿®å¤åçš„æƒé™
          echo "ä¿®å¤åæƒé™:"
          ls -la
          
      - name: Configure Git to ignore permission changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # å…³é”®è®¾ç½®ï¼šå¿½ç•¥æ–‡ä»¶æ¨¡å¼ï¼ˆæƒé™ï¼‰å˜åŒ–
          git config core.fileMode false
          git config core.autocrlf input
          
      - name: Commit permission fixes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™å˜åŒ–
          git status
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A
          
          # æäº¤æƒé™ä¿®å¤
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ”§ ä¿®å¤æ–‡ä»¶å’Œç›®å½•æƒé™
            
            ä¿®å¤å†…å®¹:
            - æ‰€æœ‰ç›®å½•è®¾ç½®ä¸º 755
            - æ‰€æœ‰æ–‡ä»¶è®¾ç½®ä¸º 644ï¼ˆè„šæœ¬æ–‡ä»¶é™¤å¤–ï¼‰
            - é…ç½®Gitå¿½ç•¥æƒé™å˜åŒ–
            "
            
            git push
          else
            echo "æ²¡æœ‰æƒé™éœ€è¦ä¿®å¤"
          fi
